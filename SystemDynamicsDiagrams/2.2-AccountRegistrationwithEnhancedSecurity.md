```mermaid
sequenceDiagram
    participant C as ğŸ“± Client App
    participant LB as âš–ï¸ Load Balancer
    participant API as ğŸŒ HTTP API Gateway
    participant RC as ğŸ“ RegistrationController
    participant PVTM as ğŸ« PhoneVerificationTokenManager
    participant RLVM as ğŸ”’ RegistrationLockVerificationManager
    participant AM as ğŸ‘¥ AccountsManager
    participant KM as ğŸ”‘ KeysManager
    participant DB as ğŸ“Š DynamoDB
    participant CACHE as ğŸ”´ Redis Cache

    rect rgba(135, 206, 250, 0.15)
        Note over C,CACHE: ğŸš€ PHASE 1: Registration Request & Validation
        
        C->>+LB: ğŸ“¤ POST /v1/registration<br/>ğŸ“‹ {sessionId, accountAttributes, identityKeys}
        Note right of C: ğŸ“¦ Payload includes:<br/>ğŸ†” Verified sessionId<br/>ğŸ‘¤ Account attributes<br/>ğŸ” Identity keypairs (ACI/PNI)<br/>ğŸ“± Device capabilities
        
        LB->>+API: ğŸ”„ Route registration request
        API->>+RC: ğŸ“ register(RegistrationRequest)
        
        rect rgba(255, 255, 224, 0.3)
            Note over RC,PVTM: Phone Verification Check
            RC->>+PVTM: ğŸ« verifyPhoneVerificationToken(sessionId, phoneNumber)
            PVTM->>PVTM: ğŸ” Validate session exists<br/>âœ… Check verification status<br/>â±ï¸ Verify not expired (16s timeout)
            PVTM-->>-RC: âœ… Phone number verified successfully
        end
    end

    rect rgba(255, 228, 225, 0.15)
        Note over C,CACHE: ğŸ” PHASE 2: Existing Account Check & Registration Lock
        
        RC->>+AM: ğŸ” getByE164(phoneNumber)
        AM->>+DB: ğŸ“Š Query accounts table<br/>ğŸ”‘ GSI: phoneNumberIndex<br/>ğŸ“± Key: {phoneNumber}
        DB-->>-AM: ğŸ“‹ Optional<Account> result
        AM-->>-RC: ğŸ‘¤ existingAccount (if found)
        
        alt ğŸ”’ Existing Account with Registration Lock
            rect rgba(255, 240, 245, 0.3)
                Note over RC,RLVM: Registration Lock Security Flow
                RC->>+RLVM: ğŸ” verifyRegistrationLock(account, clientPin, userAgent)
                RLVM->>RLVM: ğŸš¦ Check rate limit: 1 attempt/5min per account<br/>ğŸ“Š Get attempt history from cache
                
                alt ğŸ”¢ PIN Provided
                    RLVM->>RLVM: ğŸ” Validate PIN against stored Argon2 hash<br/>ğŸ§‚ Use account-specific salt
                    
                    alt âŒ PIN Invalid
                        RLVM->>RLVM: ğŸ“Š Record failed attempt<br/>ğŸ“… Calculate idle days since last seen<br/>ğŸ”„ Increment attempt counter
                        RLVM->>+CACHE: ğŸ’¾ Store failed attempt<br/>ğŸ”‘ Key: reglock:{uuid}<br/>â° TTL: 5 minutes
                        CACHE-->>-RLVM: âœ… Attempt recorded
                        RLVM-->>RC: ğŸš« RateLimitExceededException(423)<br/>â±ï¸ {timeRemaining, attemptsLeft}
                        RC-->>API: âš ï¸ HTTP 423 Registration Locked
                        API-->>LB: ğŸ“‹ {timeRemaining, registrationLock: true, idleDays}
                        LB-->>C: ğŸ”’ Account locked - Correct PIN required
                    else âœ… PIN Valid
                        RLVM->>+CACHE: ğŸ—‘ï¸ Clear failed attempts<br/>ğŸ”‘ Key: reglock:{uuid}
                        CACHE-->>-RLVM: âœ… Attempts cleared
                        RLVM-->>RC: âœ… Registration lock verified
                    end
                else ğŸ“… 7-Day Bypass Available
                    RLVM->>RLVM: ğŸ“Š Check if account idle > 7 days<br/>ğŸ“… Compare lastSeen vs current time
                    RLVM-->>RC: âœ… Bypass allowed - account dormant
                end
                RLVM-->>-RC: ğŸ”“ Registration lock verification complete
            end
        end
    end

    rect rgba(240, 255, 240, 0.15)
        Note over C,CACHE: ğŸ‘¤ PHASE 3: Account Creation & Key Management
        
        RC->>+AM: ğŸ‘¤ create(phoneNumber, attributes, badges[], aciKey, pniKey)
        
        rect rgba(245, 255, 250, 0.3)
            Note over AM: Account Identity Generation
            AM->>AM: ğŸ†” Generate ACI UUID (Account Identity)<br/>ğŸ“± Generate PNI UUID (Phone Number Identity)<br/>ğŸ” Create Device(id: 1, authToken, salt)<br/>ğŸ“Š Initialize account metrics
        end
        
        par Account Storage
            AM->>+DB: ğŸ’¾ PutItem accounts table<br/>ğŸ”‘ Partition Key: ACI<br/>ğŸ“‹ Attributes: {phoneNumber, pni, devices[], createdAt}
            Note right of DB: ğŸ“Š Account record with:<br/>ğŸ†” ACI (primary identifier)<br/>ğŸ“± PNI (phone-linked ID)<br/>ğŸ“‹ Device list with capabilities<br/>ğŸ† Badge assignments
            DB-->>-AM: âœ… Account stored successfully
        and Key Storage
            AM->>+KM: ğŸ”‘ storeIdentityKeys(aci, pni, identityKeys)
            KM->>+DB: ğŸ’¾ PutItem keys table<br/>ğŸ”‘ Keys: ACI+PNI identity keypairs<br/>ğŸ“ Metadata: {algorithm, created, deviceId}
            DB-->>-KM: âœ… Identity keys stored
            KM-->>-AM: âœ… Keys management complete
        and Cache Update
            AM->>+CACHE: ğŸ’¾ SET account:{ACI}<br/>ğŸ“‹ Full account object<br/>â° TTL: 3600s (1 hour)
            CACHE-->>-AM: âœ… Account cached for fast access
        end
        
        AM-->>-RC: ğŸ‰ Account created successfully<br/>ğŸ“‹ {uuid: ACI, pni: PNI, deviceId: 1}
    end

    rect rgba(255, 248, 220, 0.15)
        Note over C,CACHE: ğŸ‰ PHASE 4: Registration Completion
        
        RC-->>-API: ğŸ“¤ RegistrationResponse<br/>ğŸ“‹ {uuid, pni, deviceId, storageCapable: true}
        Note right of API: ğŸ“¦ Response includes:<br/>ğŸ†” Account UUID (ACI)<br/>ğŸ“± Phone Number Identity (PNI)<br/>ğŸ“± Primary device ID<br/>ğŸ’¾ Storage capability flag
        
        API-->>-LB: âœ… HTTP 201 Created<br/>ğŸ† Registration successful
        LB-->>-C: ğŸ‰ Account registration complete!<br/>ğŸ” Ready for secure messaging
    end
```