# Signal Server Registration & Authentication Flow

## 1. Phone Number Verification

```mermaid
sequenceDiagram
    participant C as Client
    participant LB as Load Balancer
    participant API as HTTP API
    participant VC as VerificationController
    participant RSC as RegistrationServiceClient
    participant CACHE as Redis Cache

    Note over C,CACHE: Phase 1: SMS/Voice Verification Setup

    C->>+LB: POST /v1/verification/session<br/>{number, pushToken}
    LB->>+API: Route request
    API->>+VC: createSession(CreateVerificationSessionRequest)
    VC->>VC: Validate phone number format
    VC->>+RSC: createRegistrationSession(phoneNumber, sourceHost)
    Note right of RSC: gRPC call to Registration Service<br/>Timeout: 15s
    RSC-->>-VC: RegistrationServiceSession<br/>(sessionId, expiration: 10min)
    VC->>+CACHE: Store session<br/>Key: sessionId, TTL: 10min
    CACHE-->>-VC: Session cached
    VC-->>-API: VerificationSessionResponse<br/>(sessionId, requestedInfo[CAPTCHA])
    API-->>-LB: HTTP 200 OK
    LB-->>-C: Session created

    C->>+LB: PATCH /v1/verification/session/{sessionId}<br/>{transport: "sms", captcha}
    LB->>+API: Route code request
    API->>+VC: updateSession(sessionId, transport)
    VC->>+CACHE: Validate session exists
    CACHE-->>-VC: Session found
    VC->>+RSC: sendVerificationCode(sessionId, SMS, clientType)
    Note right of RSC: Forwards to Twilio/Voice provider<br/>Rate limit: 1 req/min per number
    RSC-->>-VC: RegistrationServiceSession(verified: false)
    VC->>+CACHE: Update session state
    CACHE-->>-VC: Updated
    VC-->>-API: VerificationSessionResponse
    API-->>-LB: HTTP 200 OK
    LB-->>-C: Code sent via SMS
```

## 2. Account Registration with Security Checks

```mermaid
sequenceDiagram
    participant C as Client
    participant LB as Load Balancer
    participant API as HTTP API
    participant RC as RegistrationController
    participant PVTM as PhoneVerificationTokenManager
    participant RLVM as RegistrationLockVerificationManager
    participant AM as AccountsManager
    participant DB as DynamoDB
    participant CACHE as Redis Cache

    Note over C,CACHE: Phase 2: Account Creation & Registration Lock

    C->>+LB: POST /v1/registration<br/>{sessionId, accountAttributes, identityKeys}
    LB->>+API: Route registration
    API->>+RC: register(RegistrationRequest)
    
    RC->>+PVTM: verifyPhoneVerificationToken(sessionId, number)
    PVTM->>PVTM: Validate session is verified<br/>Timeout: 16s
    PVTM-->>-RC: Phone number verified
    
    RC->>+AM: getByE164(phoneNumber)
    AM->>+DB: Query accounts table<br/>GSI: phoneNumberIndex
    DB-->>-AM: Optional<Account>
    AM-->>-RC: existingAccount
    
    alt Existing Account with Registration Lock
        RC->>+RLVM: verifyRegistrationLock(account, clientPin, userAgent)
        RLVM->>RLVM: Check rate limit: 1 attempt/5min
        RLVM->>RLVM: Validate PIN against stored hash
        alt PIN Invalid
            RLVM->>RLVM: Record idle days since last seen
            RLVM-->>RC: RateLimitExceededException(423)
            RC-->>API: HTTP 423 Registration Locked
            API-->>LB: {timeRemaining, registrationLock: true}
            LB-->>C: Account locked - PIN required
        else PIN Valid or 7-day bypass
            RLVM-->>RC: Registration allowed
        end
    end
    
    RC->>+AM: create(number, attributes, badges[], aciKey, pniKey)
    AM->>AM: Generate ACI UUID (Account Identity)
    AM->>AM: Generate PNI UUID (Phone Number Identity)
    AM->>AM: Create Device(id: 1, authToken, salt)
    AM->>+DB: PutItem accounts table<br/>Key: ACI, attrs: {number, pni, devices[]}
    DB-->>-AM: Account stored
    AM->>+DB: PutItem keys table<br/>Keys: ACI+PNI identity keypairs
    DB-->>-AM: Keys stored
    AM->>+CACHE: SET account:{ACI}<br/>TTL: 3600s
    CACHE-->>-AM: Account cached
    AM-->>-RC: Account(uuid, pni, deviceId: 1)
    
    RC-->>-API: RegistrationResponse<br/>{uuid, pni, deviceId, storageCapable}
    API-->>-LB: HTTP 201 Created
    LB-->>-C: Registration successful
```

## 3. Device Authentication & Session Management

```mermaid
sequenceDiagram
    participant C as Client
    participant LB as Load Balancer
    participant API as HTTP API
    participant RC as RegistrationController
    participant PVTM as PhoneVerificationTokenManager
    participant RLVM as RegistrationLockVerificationManager
    participant AM as AccountsManager
    participant DB as DynamoDB
    participant CACHE as Redis Cache

    Note over C,CACHE: Phase 2: Account Creation & Registration Lock

    C->>+LB: POST /v1/registration<br/>{sessionId, accountAttributes, identityKeys}
    LB->>+API: Route registration
    API->>+RC: register(RegistrationRequest)
    
    RC->>+PVTM: verifyPhoneVerificationToken(sessionId, number)
    PVTM->>PVTM: Validate session is verified<br/>Timeout: 16s
    PVTM-->>-RC: Phone number verified
    
    RC->>+AM: getByE164(phoneNumber)
    AM->>+DB: Query accounts table<br/>GSI: phoneNumberIndex
    DB-->>-AM: Optional<Account>
    AM-->>-RC: existingAccount
    
    alt Existing Account with Registration Lock
        RC->>+RLVM: verifyRegistrationLock(account, clientPin, userAgent)
        RLVM->>RLVM: Check rate limit: 1 attempt/5min
        RLVM->>RLVM: Validate PIN against stored hash
        alt PIN Invalid
            RLVM->>RLVM: Record idle days since last seen
            RLVM-->>RC: RateLimitExceededException(423)
            RC-->>API: HTTP 423 Registration Locked
            API-->>LB: {timeRemaining, registrationLock: true}
            LB-->>C: Account locked - PIN required
        else PIN Valid or 7-day bypass
            RLVM-->>RC: Registration allowed
        end
        RLVM-->>-RC: Complete verification
    end
    
    RC->>+AM: create(number, attributes, badges[], aciKey, pniKey)
    AM->>AM: Generate ACI UUID (Account Identity)
    AM->>AM: Generate PNI UUID (Phone Number Identity)
    AM->>AM: Create Device(id: 1, authToken, salt)
    AM->>+DB: PutItem accounts table<br/>Key: ACI, attrs: {number, pni, devices[]}
    DB-->>-AM: Account stored
    AM->>+DB: PutItem keys table<br/>Keys: ACI+PNI identity keypairs
    DB-->>-AM: Keys stored
    AM->>+CACHE: SET account:{ACI}<br/>TTL: 3600s
    CACHE-->>-AM: Account cached
    AM-->>-RC: Account(uuid, pni, deviceId: 1)
    
    RC-->>-API: RegistrationResponse<br/>{uuid, pni, deviceId, storageCapable}
    API-->>-LB: HTTP 201 Created
    LB-->>-C: Registration successful
```

## Technical Notes

### Database Schema
- **Accounts Table**: Partition key: `ACI UUID`, GSI: `phoneNumber`
- **Keys Table**: Stores ACI/PNI identity keys and signed prekeys
- **Cache TTL**: 1 hour for account data, 10 minutes for verification sessions

### Security Features
- **Registration Lock**: PIN-based protection, 7-day bypass window
- **Rate Limiting**: 1 verification attempt per 5 minutes
- **Token Validation**: HMAC-SHA256 salted token verification
- **Device Expiry**: 30-day inactivity timeout

### Performance Optimizations
- **Redis Caching**: Account data cached to reduce DB queries
- **Connection Pooling**: HTTP/1.1 with keepalive to Registration Service
- **Circuit Breaker**: Fault tolerance for external service calls