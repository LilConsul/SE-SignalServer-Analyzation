%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#1f2937',
    'primaryTextColor': '#f9fafb',
    'primaryBorderColor': '#374151',
    'lineColor': '#6b7280',
    'secondaryColor': '#374151',
    'tertiaryColor': '#4b5563',
    'background': '#111827',
    'mainBkg': '#1f2937',
    'secondBkg': '#374151',
    'tertiaryBkg': '#4b5563'
  }
}}%%
sequenceDiagram
    participant C1 as ğŸ“± Signal Client A
    participant LB as âš–ï¸ Load Balancer
    participant HTTP as ğŸŒ HTTP Server
    participant AUTH as ğŸ” Auth Service
    participant CTRL as ğŸ® Message Controller
    participant SENDER as ğŸ“¤ Message Sender
    participant MMGR as ğŸ’¬ Messages Manager
    participant REDIS as ğŸ”´ Redis Cache
    participant DYNAMO as ğŸ—ƒï¸ DynamoDB
    participant PUSHMGR as ğŸ”” Push Manager
    participant APN as ğŸ Apple Push
    participant FCM as ğŸ¤– Firebase FCM
    participant C2 as ğŸ“± Signal Client B
    participant WS as ğŸ”Œ WebSocket Server
    participant CONN as ğŸ”— Connection Manager

    rect rgb(30, 41, 59)
        Note over C1,CONN: ğŸ“¨ Message Send Flow
    end

    C1->>+LB: POST /v1/messages/{destination}
    Note right of C1: User sends encrypted message

    LB->>+HTTP: Route to available server
    HTTP->>+AUTH: Validate credentials

    rect rgb(59, 41, 30)
        AUTH->>AUTH: Check auth token
        AUTH->>AUTH: Verify device registration
    end

    AUTH-->>-HTTP: âœ… Authenticated Device

    HTTP->>+CTRL: Process message envelope
    Note right of CTRL: Validate size & format

    CTRL->>+SENDER: Send to destination(s)

    rect rgb(30, 59, 41)
        SENDER->>SENDER: Validate recipients
        SENDER->>SENDER: Check content limits
    end

    SENDER->>+MMGR: Store message

    MMGR->>+REDIS: Check recipient status
    REDIS-->>-MMGR: ğŸŸ¢ Online / ğŸ”´ Offline

    MMGR->>+DYNAMO: Persist to message queue
    DYNAMO-->>-MMGR: âœ… Stored successfully
    MMGR-->>-SENDER: Delivery status map

    rect rgb(59, 30, 59)
        Note over SENDER,FCM: Push Notification Logic

        loop For each recipient device
            alt ğŸ”´ Recipient is offline
                SENDER->>+PUSHMGR: Send push notification

                alt ğŸ iOS Device
                    PUSHMGR->>+APN: APNS notification
                    APN-->>-PUSHMGR: âœ… Sent
                else ğŸ¤– Android Device
                    PUSHMGR->>+FCM: FCM notification
                    FCM-->>-PUSHMGR: âœ… Sent
                end

                PUSHMGR-->>-SENDER: ğŸ”” Push dispatched

            else ğŸŸ¢ Recipient is online
                SENDER->>+CONN: Real-time delivery
                CONN->>+WS: WebSocket message
                WS->>+C2: ğŸ“¨ Live message
                C2-->>-WS: âœ… Received
                WS-->>-CONN: âœ… Confirmed
                CONN-->>-SENDER: âš¡ Real-time complete
            end
        end
    end

    SENDER-->>-CTRL: âœ… Processing complete
    CTRL-->>-HTTP: Success response
    HTTP-->>-LB: 200 OK
    LB-->>-C1: âœ… Message sent

    rect rgb(30, 59, 30)
        Note over C2,DYNAMO: ğŸ“¥ Message Retrieval (Offline Messages)
    end

    C2->>+WS: ğŸ”Œ Connect to server
    WS->>+CONN: Register connection

    CONN->>+MMGR: Request pending messages
    MMGR->>+DYNAMO: Query message queue
    DYNAMO-->>-MMGR: ğŸ“¦ Queued messages
    MMGR-->>-CONN: Message batch

    CONN->>+WS: Deliver batch
    WS->>+C2: ğŸ“¨ Multiple messages
    C2-->>-WS: âœ… All received
    WS-->>-CONN: âœ… Batch delivered
    CONN-->>-WS: ğŸ¯ Sync complete