%%{init: {
  'theme': 'dark',
  'themeVariables': {
    'primaryColor': '#1f2937',
    'primaryTextColor': '#f9fafb',
    'primaryBorderColor': '#374151',
    'lineColor': '#6b7280',
    'secondaryColor': '#374151',
    'tertiaryColor': '#4b5563',
    'background': '#111827',
    'mainBkg': '#1f2937',
    'secondBkg': '#374151',
    'tertiaryBkg': '#4b5563'
  }
}}%%
sequenceDiagram
    participant C1 as ðŸ“± Client A
    participant LB as âš–ï¸ LB
    participant API as ðŸŒ API
    participant AUTH as ðŸ” Auth
    participant MSG as ðŸ“¤ Messaging
    participant CACHE as ðŸ”´ Cache
    participant DB as ðŸ—ƒï¸ DB
    participant PUSH as ðŸ”” Push
    participant C2 as ðŸ“± Client B

    rect rgb(30, 41, 59)
        Note over C1,C2: ðŸ“¨ Message Flow
    end

    C1->>+LB: POST /v1/messages
    LB->>+API: Route request
    API->>+AUTH: Validate ðŸ”
    AUTH-->>-API: âœ… Valid

    API->>+MSG: Process message
    MSG->>MSG: Validate & format

    par Check recipient status
        MSG->>+CACHE: Check online status
        CACHE-->>-MSG: ðŸŸ¢/ðŸ”´ Status
    and Store message
        MSG->>+DB: Store message
        DB-->>-MSG: âœ… Stored
    end

    alt ðŸ”´ Recipient offline
        MSG->>+PUSH: Send notification
        PUSH->>PUSH: ðŸŽ APNS / ðŸ¤– FCM
        PUSH-->>-MSG: ðŸ”” Sent
    else ðŸŸ¢ Recipient online
        MSG->>C2: âš¡ Real-time delivery
        C2-->>MSG: âœ… Received
    end

    MSG-->>-API: âœ… Complete
    API-->>-LB: 200 OK
    LB-->>-C1: âœ… Sent

    rect rgb(30, 59, 30)
        Note over C2,DB: ðŸ“¥ Offline Message Sync
    end

    C2->>+API: ðŸ”Œ Connect
    API->>+DB: Get pending messages
    DB-->>-API: ðŸ“¦ Messages
    API->>C2: ðŸ“¨ Batch delivery
    C2-->>API: âœ… Synced